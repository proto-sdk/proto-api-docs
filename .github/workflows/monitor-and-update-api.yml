name: Monitor and Update Proto API

on:
  schedule:
    # Run daily at 9 AM UTC (1 AM PST / 4 AM EST)
    - cron: '0 9 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout proto-api-docs
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          fetch-depth: 0
      
      - name: Fetch upstream API spec
        id: fetch
        env:
          GITHUB_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
        run: |
          echo "üì• Fetching latest API spec from miner-firmware..."
          
          # Download the latest MDK-API.json from miner-firmware (private repo)
          curl -s -H "Authorization: token $GITHUB_TOKEN" \
            https://raw.githubusercontent.com/btc-mining/miner-firmware/main/crates/miner-api-server/docs/MDK-API.json \
            -o /tmp/upstream-spec.json
          
          # Validate it's valid JSON
          if ! jq empty /tmp/upstream-spec.json 2>/dev/null; then
            echo "‚ùå Invalid JSON from upstream"
            exit 1
          fi
          
          # Extract versions
          UPSTREAM_VERSION=$(jq -r '.info.version' /tmp/upstream-spec.json)
          CURRENT_VERSION=$(jq -r '.info.version' spec.json)
          
          echo "upstream_version=$UPSTREAM_VERSION" >> $GITHUB_OUTPUT
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          
          echo "üìä Current version: $CURRENT_VERSION"
          echo "üìä Upstream version: $UPSTREAM_VERSION"
          
          # Check if version changed
          if [ "$UPSTREAM_VERSION" != "$CURRENT_VERSION" ]; then
            echo "version_changed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Version changed: $CURRENT_VERSION ‚Üí $UPSTREAM_VERSION"
          else
            echo "version_changed=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  No version change detected"
          fi
      
      - name: Notify version change detected
        if: steps.fetch.outputs.version_changed == 'true'
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          CURRENT_VERSION="${{ steps.fetch.outputs.current_version }}"
          UPSTREAM_VERSION="${{ steps.fetch.outputs.upstream_version }}"
          
          curl -X POST "$SLACK_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d @- << EOF
          {
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "üîî New Proto API Version Detected!",
                  "emoji": true
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Current Version:*\n$CURRENT_VERSION"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*New Version:*\n$UPSTREAM_VERSION"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "ü§ñ Starting automatic documentation update..."
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "üìñ View API Docs",
                      "emoji": true
                    },
                    "url": "https://proto-sdk.github.io/proto-api-docs/",
                    "style": "primary"
                  }
                ]
              }
            ]
          }
          EOF
      
      - name: Update API specification
        if: steps.fetch.outputs.version_changed == 'true'
        run: |
          echo "üìù Updating spec.json..."
          
          # Backup current spec
          cp spec.json spec.json.backup.$(date +%Y%m%d_%H%M%S)
          
          # Update the spec - rename title to match our branding
          jq '.info.title = "Proto Mining API"' /tmp/upstream-spec.json > spec.json
          
          echo "‚úÖ spec.json updated"
      
      - name: Update CHANGELOG
        if: steps.fetch.outputs.version_changed == 'true'
        run: |
          echo "üìù Updating CHANGELOG.md..."
          
          UPSTREAM_VERSION="${{ steps.fetch.outputs.upstream_version }}"
          CURRENT_VERSION="${{ steps.fetch.outputs.current_version }}"
          DATE=$(date +%Y-%m-%d)
          
          # Create changelog entry
          cat > /tmp/changelog_entry.md << EOF
          ## [$UPSTREAM_VERSION] - $DATE

          ### Changed
          - Updated API specification from miner-firmware upstream
          - Version bump: $CURRENT_VERSION ‚Üí $UPSTREAM_VERSION
          - Automatically synchronized with btc-mining/miner-firmware

          EOF
          
          # Prepend to CHANGELOG (after the title)
          if [ -f CHANGELOG.md ]; then
            # Insert after the first line (title)
            sed -i '1 r /tmp/changelog_entry.md' CHANGELOG.md
          else
            # Create new changelog
            echo "# Changelog" > CHANGELOG.md
            cat /tmp/changelog_entry.md >> CHANGELOG.md
          fi
          
          echo "‚úÖ CHANGELOG.md updated"
      
      - name: Commit and push changes
        if: steps.fetch.outputs.version_changed == 'true'
        run: |
          git config user.name "Proto API Bot"
          git config user.email "mining@block.xyz"
          
          git add spec.json CHANGELOG.md spec.json.backup.*
          git commit -m "ü§ñ Auto-update: Proto API v${{ steps.fetch.outputs.upstream_version }}

          - Updated from miner-firmware upstream
          - Previous version: ${{ steps.fetch.outputs.current_version }}
          - New version: ${{ steps.fetch.outputs.upstream_version }}
          - Auto-generated by monitor-and-update-api workflow"
          
          git push
          
          echo "‚úÖ Changes pushed to main branch"
      
      - name: Wait for GitHub Pages deployment
        if: steps.fetch.outputs.version_changed == 'true'
        run: |
          echo "‚è≥ Waiting 60 seconds for GitHub Pages to deploy..."
          sleep 60
      
      - name: Extract changelog details
        if: steps.fetch.outputs.version_changed == 'true'
        id: changelog
        run: |
          UPSTREAM_VERSION="${{ steps.fetch.outputs.upstream_version }}"
          
          # Extract the changelog section for the new version
          # This captures everything between the version header and the next version header
          CHANGELOG_SECTION=$(awk -v version="$UPSTREAM_VERSION" '
            /^## \[/ {
              if (found) exit;
              if ($0 ~ "\\[" version "\\]") {
                found=1;
                next;
              }
            }
            found && /^## \[/ { exit }
            found { print }
          ' CHANGELOG.md)
          
          # Extract "Added" section
          ADDED=$(echo "$CHANGELOG_SECTION" | awk '
            /^### Added/ { found=1; next }
            /^### / { found=0 }
            found && NF { print }
          ' | head -20)
          
          # Extract "Changed" section
          CHANGED=$(echo "$CHANGELOG_SECTION" | awk '
            /^### Changed/ { found=1; next }
            /^### / { found=0 }
            found && NF { print }
          ' | head -20)
          
          # Format for Slack - convert bullets and limit lines
          format_for_slack() {
            echo "$1" | sed 's/^- /‚Ä¢ /' | sed 's/^  - /  ‚ó¶ /' | head -10
          }
          
          ADDED_FORMATTED=$(format_for_slack "$ADDED")
          CHANGED_FORMATTED=$(format_for_slack "$CHANGED")
          
          # Save to output using delimiter for multiline
          {
            echo "added<<EOF_ADDED"
            echo "$ADDED_FORMATTED"
            echo "EOF_ADDED"
            echo "changed<<EOF_CHANGED"
            echo "$CHANGED_FORMATTED"
            echo "EOF_CHANGED"
          } >> $GITHUB_OUTPUT
          
          echo "‚úÖ Changelog details extracted"
      
      - name: Notify completion to #proto-documentation
        if: steps.fetch.outputs.version_changed == 'true'
        env:
          SLACK_WEBHOOK_DOCS: ${{ secrets.SLACK_WEBHOOK_DOCS_CHANNEL }}
        run: |
          UPSTREAM_VERSION="${{ steps.fetch.outputs.upstream_version }}"
          CURRENT_VERSION="${{ steps.fetch.outputs.current_version }}"
          COMMIT_SHA=$(git rev-parse --short HEAD)
          
          # Read changelog outputs (properly escaped by GitHub Actions)
          ADDED=$(cat << 'ADDED_EOF'
          ${{ steps.changelog.outputs.added }}
          ADDED_EOF
          )
          
          CHANGED=$(cat << 'CHANGED_EOF'
          ${{ steps.changelog.outputs.changed }}
          CHANGED_EOF
          )
          
          # Build the Slack message using jq for proper JSON escaping
          ADDED_JSON=$(echo "$ADDED" | jq -Rs .)
          CHANGED_JSON=$(echo "$CHANGED" | jq -Rs .)
          
          # Build changelog blocks array
          CHANGELOG_BLOCKS="[]"
          
          if [ -n "$ADDED" ] && [ "$ADDED" != "" ]; then
            CHANGELOG_BLOCKS=$(echo "$CHANGELOG_BLOCKS" | jq --arg text "*‚ú® What's New:*\n$ADDED" '. += [{
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": $text
              }
            }]')
          fi
          
          if [ -n "$CHANGED" ] && [ "$CHANGED" != "" ]; then
            CHANGELOG_BLOCKS=$(echo "$CHANGELOG_BLOCKS" | jq --arg text "*üîÑ Changes:*\n$CHANGED" '. += [{
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": $text
              }
            }]')
          fi
          
          # Add divider if we have changelog content
          if [ "$(echo "$CHANGELOG_BLOCKS" | jq 'length')" -gt 0 ]; then
            CHANGELOG_BLOCKS=$(echo "$CHANGELOG_BLOCKS" | jq '. += [{"type": "divider"}]')
          fi
          
          # Build the complete Slack message
          jq -n \
            --arg current "$CURRENT_VERSION" \
            --arg upstream "$UPSTREAM_VERSION" \
            --arg commit "$COMMIT_SHA" \
            --argjson changelog "$CHANGELOG_BLOCKS" \
            '{
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚úÖ Proto Mining API Documentation Updated!",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Version:*\n\($current) ‚Üí \($upstream)"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\n‚úÖ Live"
                    }
                  ]
                },
                {
                  "type": "divider"
                }
              ] + $changelog + [
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "üìñ View API Docs",
                        "emoji": true
                      },
                      "url": "https://proto-sdk.github.io/proto-api-docs/",
                      "style": "primary"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "üìù View Changelog",
                        "emoji": true
                      },
                      "url": "https://github.com/proto-sdk/proto-api-docs/blob/main/CHANGELOG.md"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "üîç View Commit",
                        "emoji": true
                      },
                      "url": "https://github.com/proto-sdk/proto-api-docs/commit/\($commit)"
                    }
                  ]
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "ü§ñ Automatically updated by Proto API Monitor"
                    }
                  ]
                }
              ]
            }' | curl -X POST "$SLACK_WEBHOOK_DOCS" \
              -H 'Content-Type: application/json' \
              -d @-
          
          echo "‚úÖ Notification sent to #proto-documentation"
      
      - name: No changes detected
        if: steps.fetch.outputs.version_changed == 'false'
        run: |
          echo "‚ÑπÔ∏è  No version changes detected. Documentation is up to date."
          echo "Current version: ${{ steps.fetch.outputs.current_version }}"
