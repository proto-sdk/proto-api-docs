name: Sync MDK API and Notify

on:
  schedule:
    - cron: '0 */3 * * *'
  workflow_dispatch:

jobs:
  sync-and-notify:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.PROTO_API_AUTOMATION }}
          fetch-depth: 0
      
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      
      - name: Fetch MDK-API.json
        id: fetch
        run: |
          curl -H "Authorization: token ${{ secrets.PROTO_API_AUTOMATION }}" \
            -H "Accept: application/vnd.github.v3.raw" \
            -s "https://api.github.com/repos/btc-mining/miner-firmware/contents/crates/miner-api-server/docs/MDK-API.json" \
            -o /tmp/mdk-api.json
          
          UPSTREAM_VERSION=$(cat /tmp/mdk-api.json | jq -r '.info.version')
          CURRENT_VERSION=$(cat spec.json | jq -r '.info.version')
          
          echo "upstream_version=$UPSTREAM_VERSION" >> $GITHUB_OUTPUT
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          
          if [ "$UPSTREAM_VERSION" != "$CURRENT_VERSION" ]; then
            echo "version_changed=true" >> $GITHUB_OUTPUT
          else
            echo "version_changed=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Update spec.json
        if: steps.fetch.outputs.version_changed == 'true'
        id: update
        run: |
          cat /tmp/mdk-api.json | jq '.info.title = "Proto Mining API"' > spec.json
          
          ENDPOINT_COUNT=$(cat spec.json | jq '.paths | length')
          TAG_COUNT=$(cat spec.json | jq '.tags | length')
          
          echo "endpoint_count=$ENDPOINT_COUNT" >> $GITHUB_OUTPUT
          echo "tag_count=$TAG_COUNT" >> $GITHUB_OUTPUT
      
      - name: Update version badge
        if: steps.fetch.outputs.version_changed == 'true'
        run: |
          NEW_VERSION="${{ steps.fetch.outputs.upstream_version }}"
          sed -i "s/API v[0-9]\+\.[0-9]\+\.[0-9]\+/API v$NEW_VERSION/g" index.html
          sed -i "s/data-version=\"[0-9]\+\.[0-9]\+\.[0-9]\+\"/data-version=\"$NEW_VERSION\"/g" index.html
      
      - name: Update CHANGELOG
        if: steps.fetch.outputs.version_changed == 'true'
        run: |
          NEW_VERSION="${{ steps.fetch.outputs.upstream_version }}"
          OLD_VERSION="${{ steps.fetch.outputs.current_version }}"
          TODAY=$(date +%Y-%m-%d)
          
          cat > /tmp/changelog_entry.txt << CHANGELOG_EOF
## [$NEW_VERSION] - $TODAY

### Changed
- Synced API specification from miner-firmware repository
- Updated from version $OLD_VERSION to $NEW_VERSION
- Endpoint count: ${{ steps.update.outputs.endpoint_count }}
- Tag count: ${{ steps.update.outputs.tag_count }}

CHANGELOG_EOF
          
          if grep -q "^## \[" CHANGELOG.md; then
            awk '/^## \[/{if(!found){print ""; system("cat /tmp/changelog_entry.txt"); found=1}} {print}' CHANGELOG.md > /tmp/changelog_new.md
            mv /tmp/changelog_new.md CHANGELOG.md
          else
            echo "" >> CHANGELOG.md
            cat /tmp/changelog_entry.txt >> CHANGELOG.md
          fi
      
      - name: Get author
        if: steps.fetch.outputs.version_changed == 'true'
        id: author
        run: |
          AUTHOR=$(curl -H "Authorization: token ${{ secrets.PROTO_API_AUTOMATION }}" \
            -s "https://api.github.com/repos/btc-mining/miner-firmware/commits?path=crates/miner-api-server/docs/MDK-API.json&per_page=1" \
            | jq -r '.[0].commit.committer.name // .[0].commit.author.name')
          
          if [ -z "$AUTHOR" ] || [ "$AUTHOR" = "null" ]; then
            AUTHOR="Proto API Bot"
          fi
          
          echo "author=$AUTHOR" >> $GITHUB_OUTPUT
      
      - name: Commit changes
        if: steps.fetch.outputs.version_changed == 'true'
        id: commit
        run: |
          git config user.name "Proto API Bot"
          git config user.email "api-bot@proto-sdk.github.io"
          
          COMMIT_MSG="chore: sync API spec to v${{ steps.fetch.outputs.upstream_version }} from miner-firmware"
          
          git add spec.json index.html CHANGELOG.md
          git commit -m "$COMMIT_MSG

- Updated spec.json from MDK-API.json
- Updated version badge in index.html
- Updated CHANGELOG.md
- Endpoints: ${{ steps.update.outputs.endpoint_count }}
- Tags: ${{ steps.update.outputs.tag_count }}"
          
          git push origin main
          
          COMMIT_SHA=$(git rev-parse HEAD)
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "commit_message=$COMMIT_MSG" >> $GITHUB_OUTPUT
      
      - name: Notify Slack proto-documentation
        if: steps.fetch.outputs.version_changed == 'true'
        run: |
          NEW_VERSION="${{ steps.fetch.outputs.upstream_version }}"
          OLD_VERSION="${{ steps.fetch.outputs.current_version }}"
          ENDPOINT_COUNT="${{ steps.update.outputs.endpoint_count }}"
          TAG_COUNT="${{ steps.update.outputs.tag_count }}"
          COMMIT_SHA="${{ steps.commit.outputs.commit_sha }}"
          COMMIT_MSG="${{ steps.commit.outputs.commit_message }}"
          AUTHOR="${{ steps.author.outputs.author }}"
          COMMIT_URL="https://github.com/proto-sdk/proto-api-docs/commit/$COMMIT_SHA"
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          curl -X POST "${{ secrets.SLACK_WEBHOOK_PROTO_DOCUMENTATION }}" \
            -H 'Content-Type: application/json' \
            -d @- << SLACK_EOF
          {
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "Proto API Version Updated!",
                  "emoji": true
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Version:*\n$OLD_VERSION → $NEW_VERSION"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Endpoints:*\n$ENDPOINT_COUNT"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Tags:*\n$TAG_COUNT"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Author:*\n$AUTHOR"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Commit:* $COMMIT_MSG"
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View API Docs",
                      "emoji": true
                    },
                    "url": "https://proto-sdk.github.io/proto-api-docs/",
                    "style": "primary"
                  },
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View Commit",
                      "emoji": true
                    },
                    "url": "$COMMIT_URL"
                  },
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View Changelog",
                      "emoji": true
                    },
                    "url": "https://github.com/proto-sdk/proto-api-docs/blob/main/CHANGELOG.md"
                  }
                ]
              },
              {
                "type": "context",
                "elements": [
                  {
                    "type": "mrkdwn",
                    "text": "Notification sent at $TIMESTAMP"
                  }
                ]
              }
            ]
          }
          SLACK_EOF
      
      - name: Notify Slack hmoses
        if: steps.fetch.outputs.version_changed == 'true'
        run: |
          NEW_VERSION="${{ steps.fetch.outputs.upstream_version }}"
          OLD_VERSION="${{ steps.fetch.outputs.current_version }}"
          ENDPOINT_COUNT="${{ steps.update.outputs.endpoint_count }}"
          TAG_COUNT="${{ steps.update.outputs.tag_count }}"
          COMMIT_SHA="${{ steps.commit.outputs.commit_sha }}"
          COMMIT_MSG="${{ steps.commit.outputs.commit_message }}"
          AUTHOR="${{ steps.author.outputs.author }}"
          COMMIT_URL="https://github.com/proto-sdk/proto-api-docs/commit/$COMMIT_SHA"
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          curl -X POST "${{ secrets.SLACK_WEBHOOK_HMOSES }}" \
            -H 'Content-Type: application/json' \
            -d @- << SLACK_EOF
          {
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "Proto API Version Updated!",
                  "emoji": true
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Version:*\n$OLD_VERSION → $NEW_VERSION"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Endpoints:*\n$ENDPOINT_COUNT"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Tags:*\n$TAG_COUNT"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Author:*\n$AUTHOR"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Commit:* $COMMIT_MSG"
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View API Docs",
                      "emoji": true
                    },
                    "url": "https://proto-sdk.github.io/proto-api-docs/",
                    "style": "primary"
                  },
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View Commit",
                      "emoji": true
                    },
                    "url": "$COMMIT_URL"
                  },
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View Changelog",
                      "emoji": true
                    },
                    "url": "https://github.com/proto-sdk/proto-api-docs/blob/main/CHANGELOG.md"
                  }
                ]
              },
              {
                "type": "context",
                "elements": [
                  {
                    "type": "mrkdwn",
                    "text": "Notification sent at $TIMESTAMP"
                  }
                ]
              }
            ]
          }
          SLACK_EOF
